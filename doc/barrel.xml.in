<?xml version="1.0" encoding="utf-8"?>
<refentry id='barrel8' xmlns:xlink="http://www.w3.org/1999/xlink">

  <refentryinfo>
    <date>2021-09-27</date>
  </refentryinfo>

  <refmeta>
    <refentrytitle>barrel</refentrytitle>
    <manvolnum>8</manvolnum>
    <refmiscinfo class='date'>2021-09-27</refmiscinfo>
    <refmiscinfo class='version'>@VERSION@</refmiscinfo>
    <refmiscinfo class='manual'>Storage Management</refmiscinfo>
  </refmeta>

  <refnamediv>
    <refname>barrel</refname>
    <refpurpose>Command-line program for storage management</refpurpose>
  </refnamediv>

  <refsynopsisdiv id='synopsis'>
    <cmdsynopsis>
      <command>barrel</command>
      <arg choice='opt'><replaceable>--global-opts</replaceable></arg>
      <arg choice='plain'><replaceable>command</replaceable></arg>
      <arg choice='opt'><replaceable>--command-opts</replaceable></arg>
      <arg choice='opt'><replaceable>block-devices</replaceable></arg>
    </cmdsynopsis>
    <cmdsynopsis>
      <command>barrel</command>
      <arg choice='opt'><replaceable>--global-opts</replaceable></arg>
    </cmdsynopsis>
  </refsynopsisdiv>

  <refsect1 id='description'>
    <title>DESCRIPTION</title>

    <para>Barrel is a command-line program for storage management. It
    can work with file systems, LUKS, RAIDs and LVM. The main feature of
    barrel is to combine the various tools needed to manage the different
    storage systems in one tool. E.g. with a single command of barrel it
    is possible to create partitions on several disks, create a RAID from
    those partitions and create a file system on the RAID.</para>

    <para>Barrel probes the complete storage system at startup and
    does not save the state between invocations. That allows to mix barrel
    with other storage tools, although in general not concurrently.</para>
  </refsect1>

  <refsect1 id='concepts'>
    <title>CONCEPTS</title>

    <refsect2 id='modes'>
      <title>Script and Interactive Mode</title>
      <para>Barrel can run either in script or interactive mode. In
      script mode the commands must be provided on the command line. If no
      commands are provided on the command line the interactive mode is
      started where a prompt asks for the commands.</para>
    </refsect2>

    <refsect2 id='pool'>
      <title>Pool</title>
      <para>Pools are a set of devices and allow barrel to find
      suitable disk space on its own. For example when the system has
      several SSDs and the user wants to create a file system on some SSD
      barrel can pick an SSD with enough space automatically.</para>
      <para>So far devices in a pool must have a partition table to be
      usable.</para>
    </refsect2>

    <refsect2 id='stack'>
      <title>Stack</title>
      <para>Barrel has a stack of "storage objects" that allows
      commands to be chained. For example creating a RAID places the
      resulting RAID on the stack. A consecutive command to create a
      file system can then pick the RAID from the stack. Using the
      stack the user does not have to deal with the name of the newly
      created RAID and thus the two commands can be provided on the
      command line.</para>
    </refsect2>

    <refsect2 id='devicegraph'>
      <title>Devicegraph</title>
      <para>Barrel saves all information about storage devices and
      file systems together with their relations in a devicegraph. At
      startup the system is probed and the state is saved in the "probed"
      and the "staging" devicegraphs. All commands only modify the staging
      devicegraph.</para>

      <para>Barrel makes a backup of the staging devicegraph whenever
      it is modified. The last backup can be restored with the command
      <command>undo</command>.</para>

      <para>During commit barrel runs actions to make the system match
      the staging devicegraph.</para>
    </refsect2>

    <refsect2 id='modus_operandi'>
      <title>Modus Operandi of Commands</title>
      <para>Many commands operate significantly different based on the
      provided options.</para>
      <para>For example when creating a file system using
      <command>create xfs /dev/sdb1</command> the XFS is created on the
      partition /dev/sdb1. On the other hand the command <command>create xfs
      /dev/sdb --size 10G</command> will create a 10 GiB partition on
      /dev/sdb are the XFS on the new partition. And the command
      <command>create xfs</command> will take a device from the stack and
      create the XFS on that device.</para>
    </refsect2>
  </refsect1>

  <refsect1 id='global_options'>
    <title>GLOBAL OPTIONS</title>
    <variablelist>
      <varlistentry>
	<term><option>-q, --quiet</option></term>
	<listitem>
	  <para>Suppress normal output. Error messages will still be printed, though.</para>
	</listitem>
      </varlistentry>
      <varlistentry>
	<term><option>-v, --verbose</option></term>
	<listitem>
	  <para>Increase verbosity.</para>
	</listitem>
      </varlistentry>
      <varlistentry>
	<term><option>--dry-run</option></term>
	<listitem>
	  <para>Do not commit anything to disk.</para>
	</listitem>
      </varlistentry>
      <varlistentry>
	<term><option>--prefix <replaceable>path</replaceable></option></term>
	<listitem>
	  <para>Prepend verious path (mount points and files in /etc)
	  with a prefix. Useful when running in a installation or rescue
	  system.</para>
	</listitem>
      </varlistentry>
      <varlistentry>
	<term><option>-a, --activate</option></term>
	<listitem>
	  <para>Activate storage systems at startup. Useful when
	  running in a installation or rescue system.</para>
	</listitem>
      </varlistentry>
      <varlistentry>
	<term><option>--yes</option></term>
	<listitem>
	  <para>Do not prompt for confirmation but assume the answer
	  yes. Use with extreme caution. </para>
	</listitem>
      </varlistentry>
      <varlistentry>
	<term><option>-h, --help <replaceable>format</replaceable></option></term>
	<listitem>
	  <para>Print help and exit.</para>
	</listitem>
      </varlistentry>
      <varlistentry>
	<term><option>--version</option></term>
	<listitem>
	  <para>Print version and exit.</para>
	</listitem>
      </varlistentry>
    </variablelist>
  </refsect1>

  <refsect1 id='commands'>
    <title>COMMANDS</title>

    <para>Barrel provides a number of <emphasis>commands</emphasis>.
    Many commands have specific options, which are listed in this
    section. These command-specific options must be specified
    <emphasis>after</emphasis> the name of the command. For several
    commands some options are mandatory.</para>

    <variablelist>

      <varlistentry>
	<term><option>clear</option></term>
	<listitem>
	  <para>Clears the stack.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>commit</option></term>
	<listitem>
	  <para>Commits changes to disk and quits.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>create encryption [devices]</option></term>
	<listitem>
	  <para>Creates a new encryption device.</para>

	  <variablelist>
	    <varlistentry>
	      <term><option>-t, --type</option> <replaceable>type</replaceable></term>
	      <listitem>
		<para>Set encryption type. Possible values are luks1 and luks2.</para>
	      </listitem>
	    </varlistentry>
	    <varlistentry>
	      <term><option>-n, --name</option> <replaceable>name</replaceable></term>
	      <listitem>
		<para>Name of device-mapper device.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>create filesystem [devices]</option></term>
	<listitem>
	  <para>Creates a new file system.</para>

	  <variablelist>
            <varlistentry>
              <term><option>-t, --type</option> <replaceable>type</replaceable></term>
              <listitem>
		<para>Set file system type. Possible values are
		btrfs, exfat, ext2, ext3, ext4, swap, vfat, xfs.</para>
	      </listitem>
            </varlistentry>
            <varlistentry>
              <term><option>-p, --path</option> <replaceable>path</replaceable></term>
              <listitem>
		<para>Path to mount the filesystem.</para>
              </listitem>
            </varlistentry>
          </variablelist>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>create lv</option></term>
	<listitem>
	  <para>Creates a new LVM logical volume.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>create partition-table</option></term>
	<listitem>
	  <para>Creates a new partition table.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>create pool <replaceable>devices</replaceable></option></term>
	<listitem>
	  <para>Creates a new pool containing devices.</para>

	  <variablelist>
	    <varlistentry>
	      <term><option>-n, --name</option> <replaceable>name</replaceable></term>
	      <listitem>
		<para>Name of pool.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>create raid <replaceable>[devices]</replaceable></option></term>
	<listitem>
	  <para>Creates a new RAID.</para>

	  <variablelist>
	    <varlistentry>
	      <term><option>-l, --level</option> <replaceable>level</replaceable></term>
	      <listitem>
		<para>Set RAID level. Possible values are 0, strip, 1,
		mirror, 4, 5, 6 and 10.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>create vg <replaceable>[devices]</replaceable></option></term>
	<listitem>
	  <para>Creates a new LVM volume group.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>dup</option></term>
	<listitem>
	  <para>Duplicates the top object of the stack.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>extend pool <replaceable>devices</replaceable></option></term>
	<listitem>
	  <para>Adds devices to a pool.</para>

	  <variablelist>
	    <varlistentry>
	      <term><option>-n, --name</option> <replaceable>name</replaceable></term>
	      <listitem>
		<para>Name of pool.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>help <replaceable>[main-command [sub-command]]</replaceable></option></term>
	<listitem>
	  <para>Shows help.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>load devicegraph</option></term>
	<listitem>
	  <para>Loads the staging devicegraph from a file.</para>
	  <para>This function is still in development. Use with great care.</para>

	  <variablelist>
	    <varlistentry>
	      <term><option>-n, --name</option> <replaceable>name</replaceable></term>
	      <listitem>
		<para>Name of devicegraph file.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>
	  <variablelist>
	    <varlistentry>
	      <term><option>-m, --mapping</option> <replaceable>name</replaceable></term>
	      <listitem>
		<para>Name of mapping file.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>load pools</option></term>
	<listitem>
	  <para>Explicitly loads pools from
	  /etc/barrel/pools.json. Pools are automatically loaded at startup.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>pop</option></term>
	<listitem>
	  <para>Removes the top object from the stack.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>quit</option></term>
	<listitem>
	  <para>Quits barrel.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>reduce pool <replaceable>devices</replaceable></option></term>
	<listitem>
	  <para>Removes devices from a pool.</para>

	  <variablelist>
	    <varlistentry>
	      <term><option>-n, --name</option> <replaceable>name</replaceable></term>
	      <listitem>
		<para>Name of pool.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>remove device <replaceable>devices</replaceable></option></term>
	<listitem>
	  <para>Removes a device and all device and file systems using
	  it. When removing a RAID or encryption device the underlying
	  partitions are also removed.</para>

	  <variablelist>
	    <varlistentry>
	      <term><option>--keep-partitions</option></term>
	      <listitem>
		<para>Keep underlying partitions.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>remove pool <replaceable>devices</replaceable></option></term>
	<listitem>
	  <para>Removes a pool.</para>

	  <variablelist>
	    <varlistentry>
	      <term><option>-n, --name</option> <replaceable>name</replaceable></term>
	      <listitem>
		<para>Name of pool.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>rename pool</option></term>
	<listitem>
	  <para>Renames a pool.</para>

	  <variablelist>
	    <varlistentry>
	      <term><option>-o, --old-name</option> <replaceable>name</replaceable></term>
	      <listitem>
		<para>Old name of pool.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>
	  <variablelist>
	    <varlistentry>
	      <term><option>-n, --new-name</option> <replaceable>name</replaceable></term>
	      <listitem>
		<para>New name of pool.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>save devicegraph</option></term>
	<listitem>
	  <para>Saves the staging devicegraph to a file.</para>

	  <variablelist>
	    <varlistentry>
	      <term><option>-n, --name</option> <replaceable>name</replaceable></term>
	      <listitem>
		<para>Name of devicegraph file.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>save pools</option></term>
	<listitem>
	  <para>Explicitly saves pools in
	  /etc/barrel/pools.json. Pools are also saved during commit if
	  modified.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>show commit</option></term>
	<listitem>
	  <para>Shows commit actions.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>show dasds</option></term>
	<listitem>
	  <para>Shows DASDs.</para>

	  <variablelist>
	    <varlistentry>
	      <term><option>--probed</option></term>
	      <listitem>
		<para>Show DASDs of the probed instead of the staging devicegraph.</para>
	      </listitem>
	    </varlistentry>
	    <varlistentry>
	      <term><option>--no-partitions</option></term>
	      <listitem>
		<para>Do not show partitions on the DASDs.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>show disks</option></term>
	<listitem>
	  <para>Shows disks.</para>

	  <variablelist>
	    <varlistentry>
	      <term><option>--probed</option></term>
	      <listitem>
		<para>Show disks of the probed instead of the staging devicegraph.</para>
	      </listitem>
	    </varlistentry>
	    <varlistentry>
	      <term><option>--no-partitions</option></term>
	      <listitem>
		<para>Do not show partitions on the disks.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>show encryptions</option></term>
	<listitem>
	  <para>Shows encryption devices.</para>

	  <variablelist>
	    <varlistentry>
	      <term><option>--probed</option></term>
	      <listitem>
		<para>Show encryption devices of the probed instead of the staging devicegraph.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>show filesystems</option></term>
	<listitem>
	  <para>Shows file systems.</para>

	  <variablelist>
	    <varlistentry>
	      <term><option>--probed</option></term>
	      <listitem>
		<para>Show file systems of the probed instead of the staging devicegraph.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>show pools</option></term>
	<listitem>
	  <para>Shows pools.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>show raids</option></term>
	<listitem>
	  <para>Shows RAIDs.</para>

	  <variablelist>
	    <varlistentry>
	      <term><option>--probed</option></term>
	      <listitem>
		<para>Show RAIDs of the probed instead of the staging devicegraph.</para>
	      </listitem>
	    </varlistentry>
	    <varlistentry>
	      <term><option>--no-partitions</option></term>
	      <listitem>
		<para>Do not show partitions on the RAIDs.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>show vgs</option></term>
	<listitem>
	  <para>Shows LVM volume groups.</para>

	  <variablelist>
	    <varlistentry>
	      <term><option>--probed</option></term>
	      <listitem>
		<para>Show volume groups of the probed instead of the staging devicegraph.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>stack</option></term>
	<listitem>
	  <para>Prints the stack.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><option>undo</option></term>
	<listitem>
	  <para>Restores the staging devicegraph to the last backup.</para>
	</listitem>
      </varlistentry>

    </variablelist>
  </refsect1>

  <refsect1 id='examples'>
    <title>EXAMPLES</title>
    <variablelist>
      <varlistentry>
	<term><command>barrel create xfs /dev/sdb1 --path /test</command></term>
	<listitem>
	  <para>Create an XFS on /dev/sdb1 and mount it at /test.</para>
	</listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
	<term><command>barrel create xfs /dev/sdb --size 10G --path /test</command></term>
	<listitem>
	  <para>Create a 10 GiB partition on /dev/sdb with an XFS and
	  mount it at /test.</para>
	</listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
	<term><command>barrel create raid1 /dev/sd[bc]1 xfs --path /test</command></term>
	<listitem>
	  <para>Create a RAID1 on /dev/sdb1 and /dev/sdc1 with an XFS
	  and mounted at /test.</para>
	</listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
	<term><command>barrel create raid5 --size 1TiB --pool "HDDs (512 B)"
	--devices 3+1 xfs --path /test</command></term>
	<listitem>
	  <para>Create a 1 TiB RAID5 with 3 devices and 1 spare from
	  devices in the pool "HDDs (512 B)" and an XFS on the RAID
	  mounted at /test.</para>
	</listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
	<term><command>barrel create vg --name vg1 --size 1TiB /dev/sdb
	lv --name lv1 --size 100G xfs --path /test</command></term>
	<listitem>
	  <para>Create a new 1 TiB partition on /dev/sdb, create a
	  volume group with name vg1 using the partition, create a logical
	  volume with name lv1 and size 100G within the volume group and finally
	  create an XFS on the logical volume and mount it at /test.</para>
	</listitem>
      </varlistentry>
    </variablelist>
  </refsect1>

  <refsect1 id='files'>
    <title>FILES</title>
    <variablelist>
      <varlistentry>
	<term><filename>/etc/barrel/pools.json</filename></term>
	<listitem>
	  <para>JSON file defining pools.</para>
	</listitem>
      </varlistentry>
    </variablelist>
  </refsect1>

  <refsect1 id='bugs'>
    <title>BUGS</title>
    <itemizedlist>
      <listitem>
	<para>Validation of input is unfinished.</para>
      </listitem>
      <listitem>
	<para>Missing tools are not installed on demand.</para>
      </listitem>
      <listitem>
	<para>Tools doing automounts, e.g. systemd and desktop
	environments, can cause race conditions.</para>
      </listitem>
      <listitem>
	<para>Translations are missing.</para>
      </listitem>
      <listitem>
	<para>Imcomplete support for multipath and DASDs.</para>
      </listitem>
      <listitem>
	<para>Tab completion in the interactive mode is not context aware.</para>
      </listitem>
    </itemizedlist>
  </refsect1>

  <refsect1 id='homepage'>
    <title>HOMEPAGE</title>
    <para><ulink url='http://github.com/aschnell/barrel/'>http://github.com/aschnell/barrel/</ulink></para>
  </refsect1>

  <refsect1 id='authors'>
    <title>AUTHORS</title>
    <para>Arvin Schnell <email>aschnell@suse.com</email></para>
  </refsect1>

  <refsect1 id='see_also'>
    <title>SEE ALSO</title>
    <para>
      <citerefentry role="nolink"><refentrytitle>parted</refentrytitle><manvolnum>8</manvolnum></citerefentry>,
      <citerefentry role="nolink"><refentrytitle>mkfs</refentrytitle><manvolnum>8</manvolnum></citerefentry>,
      <citerefentry role="nolink"><refentrytitle>mount</refentrytitle><manvolnum>8</manvolnum></citerefentry>,
      <citerefentry role="nolink"><refentrytitle>mdadm</refentrytitle><manvolnum>8</manvolnum></citerefentry>,
      <citerefentry role="nolink"><refentrytitle>lvm</refentrytitle><manvolnum>8</manvolnum></citerefentry>,
      <citerefentry role="nolink"><refentrytitle>cryptsetup</refentrytitle><manvolnum>8</manvolnum></citerefentry>,
      <citerefentry role="nolink"><refentrytitle>fstab</refentrytitle><manvolnum>5</manvolnum></citerefentry>,
      <citerefentry role="nolink"><refentrytitle>crypttab</refentrytitle><manvolnum>5</manvolnum></citerefentry>,
      <citerefentry role="nolink"><refentrytitle>mdadm.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry>,
    </para>
  </refsect1>

</refentry>
